#include <stdio.h>
#include <stdlib.h>

// remplace les occurences d'un chaine de caractère par une autre

char *strsub(const char *s, const char *motif, const char *par) {
    int MAX_SIZE=4096;  // taille maximale
    char * res=NULL;     // resultat obtenu
    char * res2=NULL;     // copie du pointeur resultat
    const char * m=NULL; // copie du pointeur motif
    const char * ss=NULL; // copie du pointeur s
    const char * cp=NULL; // copie du pointeur par
    int i=0,n=0;


    res = malloc(MAX_SIZE*(sizeof(char)));
    if (!res) {      // on teste si l'allocation mémoire s'est bien passée
        fprintf(stderr,"Erreur allocation mémoire");
        exit(EXIT_FAILURE);
    }
    res2 = res;

    while (*s) {     // tant qu'on n'est pas à la fin de la chaine s
        if (*s != *motif) { // si le 1er caractère n'est pas le même que motif
            *res2 = *s; // on recopie dans résultat
            res2++;     // on passe au suivant de res
        } else {
            m = motif;  // on réinitialise le pointeur m sur le 1er car de motif
            ss = s; // on sauvegarde l'endroit où on était arrivé dans s
            n=0;
            while (*m) {    // on avance si d'autre car correspondent
                if (*ss == *m) { // si le car est identique
                    m++;    // on passe au suivant
                    ss++;   // on passe au suivant
                    n++;
                } else break;   // sinon on arrête de comparer
            }
            if (!*m) {  // on est arrivé à la fin du motif = on a trouvé le motif
                cp = par;   // on recopie le pointeur cp
                while(*cp) { // tant qu'on est pas à la fin de cp
                    *res2 = *cp;    // on met dans res2 le mot qui remplace motif
                    cp++;
                    res2++;
                }
                s = ss; // on repositionne le pointeur de s à la fin du motif
            } else { // on n'a pas trouvé le motif
                ss = s;           
                for (i=0;i<n;i++) {  // on recopie les car qui étaient id à motif
                    *res2 = *ss;
                    res2++;
                    ss++;
                }
                s = ss-1;
            }
        }
        if (*s) s++;     // on passe au caractère suivant (on teste avant si on n'est pas à la fin de la phrase)
    }
    return res;
}

int main(){
    char ph[]="Bonsoir, il fait beau ce soir !";
    printf("Application de \"soir\" -> \"jour\" sur \"%s\" : \n",ph);
    printf("%s\n\n",strsub(ph,"soir","jour")); // Bonjour, il faut beau ce jour !

    char ph2[]="ce soir, sosoir";
    printf("Application de \"sosoir\" -> \"jour\" sur \"%s\" : \n",ph2);
    printf("%s\n\n",strsub(ph2,"sosoir","jour")); // soir

    return EXIT_SUCCESS;
}
