/* upper2.c 
 * Ecrire une commande upper qui copie le contenu d'un fichier en
 * remplaçant les lettres minuscules en majuscules. Les noms des fichiers
 * source et résultat sont passés en argument de la commande. Vous devez pour
 * cela utiliser les appels système unix (open, read, write, close) Même
 * question, mais cette fois ci, si un seul nom de fichier est passé en argument
 * de la commande, vous devez utiliser la sortie standard pour le résultat. 
 */  
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <unistd.h>
#include <ctype.h>

int main ( int argc , char **argv ) {

    int file=0,cible=1; // numero du fichier, par defaut cible = sortie standard
                        // par défaut file = entrée standard
    char  c; // caractère

    if ( argc > 3) { // vérification du nombre de paramètres minimun
        // message d'erreur
        fprintf(stderr,"usage :  %s [source] [cible] \n",argv[0]); 
        exit(1);
    }

    // si on a 1 ou 2 arguments à la commande upper3, on ouvre le fichier d'entrée 
    if ((argc == 2 || argc == 3 )&& (file = open(argv[1],O_RDONLY)) == -1 ){
        // message d'erreur problme d'ouverture du fichier
        //fprintf(stderr,"%s : le fichier %s n'existe pas \n",argv[0],argv[1]);
        perror("upper3  open  RDONLY"); // cat: No such file or directory
        exit(errno);
    } 

    // si on 2 arg à la commande upper3, on ouvre le fichier de sortie
    if (argc == 3 && (cible = open(argv[2],O_WRONLY|O_CREAT|O_TRUNC,0644)) < 0){
        // message d'erreur problme d'ouverture du fichier
        perror("upper3 open WRONLY "); 
        exit(errno);
    }

    // Soit les fichiers sont ouverts, soit on utilise les descripteurs des fichiers i/o par défaut
    // lecture/écriture caractère par caractère
    while ((read(file,&c,1)) > 0) { //lecture dans le fichier c par c
        if (islower(c)) c=toupper(c); // transformation en majuscule
        if (write(cible,&c,1) !=  1) { /* fd = 1 sortie standard */
            perror("upper3 open write "); 
            exit(errno);
        }
    }
    close(file); //fermeture du fichier
    close(cible);

}
