/* copy .c
     affiche le contenu d'un fichier sur la sortie standard
     le nom du fichier est passe en parametre de la commande
     le fichier est lu par bloc de 512 caracteres
*/  
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <unistd.h>


int main ( int argc , char **argv ) {

  int file,cible; // numero du fichier
    if ( argc != 3 ) { // manque le nom du fichier a traiter
      // message d'erreur
      fprintf(stderr,"usage :  %s source cible \n",argv[0]); 
      exit(1);
    }
    if ((file = open(argv[1],O_RDONLY)) == -1 ){
      // message d'erreur problme d'ouverture du fichier
      //fprintf(stderr,"%s : le fichier %s n'existe pas \n",argv[0],argv[1]);
      perror("copy  open  RDONLY"); // cat: No such file or directory
      exit(errno);
    } 
  if ((cible = open(argv[2],O_WRONLY|O_CREAT|O_TRUNC,0644)) < 0){
      // message d'erreur problme d'ouverture du fichier
      perror("copy open WRONLY "); 
      exit(errno);
    }


     
#define MAX 512 // taille d'un bloc 
  char  buf[MAX]; // zone tampon (bloc)
  int nb;  // nombre caracters lu par read
  while ((nb= read(file,buf,MAX)) > 0) { //lecture dans le fichier
    if (write(cible,buf,nb) !=  nb) { /* fd = 1 sortie standard */
      perror("copy open write "); 
      exit(errno);
    }
  }
  close(file); //fermeture du fichier
  close(cible);
  
}
