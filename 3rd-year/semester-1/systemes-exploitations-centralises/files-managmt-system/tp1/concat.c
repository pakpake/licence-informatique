/* concat .c 
 * Ecrire une commande concat qui concatenne plusieurs fichiers dans
 * un fichier résultat. La liste des noms des fichiers est passée en argument
 * de la commande le dernier étant le nom du fichier résultat. Si un des
 * fichiers n'existe pas, la commande passe au fichier suivant.Les fichiers
 * sont lus par blocs de 512.
 */  
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <unistd.h>

#define MAX 512 // taille d'un bloc 


int main ( int argc , char **argv ) {

    int file,cible; // numero du fichier
    int i=1;        // compteur de boucle
    char  buf[MAX]; // zone tampon (bloc)
    int nb;         // nombre caracters lu par read

    // il faut au moins 3 arguments à concat pour concaténer
    if ( argc < 3 ) {
        // message d'erreur
        fprintf(stderr,"usage :  %s file1 [file2,3,...] file_result\n",argv[0]); 
        exit(1);
    }

    // on ouvre le fichier cible
    if ((cible = open(argv[argc-1],O_WRONLY|O_CREAT|O_TRUNC,0644)) < 0){
        // message d'erreur problme d'ouverture du fichier
        perror("concat open WRONLY "); 
        exit(errno);
    }

    // on parcourt tous les noms de fichiers intermédiaires
    for (i=1;i<argc-1;i++) {
        // si le fichier s'ouvre correctement
        // on le lit et l'écrit dans le fichier cible (sinon on ne fait rien)
        if ((file = open(argv[i],O_RDONLY)) != -1 ){

            // procédure de lecture/écriture identique à copie
            while ((nb= read(file,buf,MAX)) > 0) { //lecture dans le fichier
                if (write(cible,buf,nb) !=  nb) { /* fd = 1 sortie standard */
                    perror("copy open write "); 
                    exit(errno);
                }
            }
        }
        close(file); //fermeture du fichier intermédiaire
    }
    close(cible); // fermeture du fichier cible
}
