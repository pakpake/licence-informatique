/*
 * Écrire une fonctionnalité (w) de la commande Unix test sur un fichier dont
 * voici une page du manuel.
*/


#include <stdio.h>      //librairie standard (stderr)
#include <stdlib.h>
#include <errno.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <errno.h>
#include <unistd.h>



int main ( int argc , char **argv ) {

    struct stat etat;
    uid_t userId;
    gid_t groupId;

    // test de bonne utilisation
    if ( argc != 2 ) { 
        printf("usage :  %s file \n",argv[0]);
        exit(1);
    }

    // appel a stat pour recuperer les informations
    if (stat(argv[1],&etat) == -1) {
        perror("stat : ");
        exit(errno);
    }

    // test si le fichier existe et si c'est un fichier regulier (pas un repertoire)
    if (!S_ISREG(etat.st_mode)) {
        fprintf(stderr,"ERROR: %s n'est pas un fichier regulier\n",argv[1]);
        exit(EXIT_FAILURE);
    }

    // recupere le euid de l'utilisateur
    userId = geteuid();
    // recupere le group id 
    groupId = getegid();
    
    // on verifie si celui qui lance l'appel est le propiétaire et s'il a les droits en W
    if (etat.st_uid == userId && (etat.st_mode & 00200)) return 0;

    // on vérifie s'il a les droits de groupe et les droits en W
    if (etat.st_gid==groupId && (etat.st_mode & 00020)) return 0;

    // on vérifie si on le droit W pour tous les autres
    if (etat.st_mode & 00002) return 0;

    return 1;
}
