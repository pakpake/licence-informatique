//  ftw.c
//
// exemple d'utilisation de ftw
//  qui parcourt recusivement  un répertoire
//  affiche le droit avec les info de l'inode
//

#include <sys/types.h>
#include <sys/stat.h>
#include <ftw.h>
#include <stdlib.h>
#include <stdio.h>
#include <errno.h>

//              FTW_F     Fichier normal
//              FTW_D     Répertoire
//              FTW_NS    Echec de stat sur cet élément
//              FTW_DNR   Répertoire non lisible   

int taille=0;       // taille totale, en variable globale
// on est obligé car on ne peut pas changer les paramètres de list

// fonction appelle pour chaque  entrre
int list(const char *name, const struct stat *status, int type) {
    if (type == FTW_NS) {
        perror("stat : ");
        exit(errno);
    }
    // on rajoute 4 car la commande originale `du -k` compte le nombre 
    // de blocks du répertoire '..' sans l'explorer
    if (type == FTW_D) taille+=4;
    // si c'est un fichier régulier
    if (type == FTW_F) {
        // printf("%-25s nombre de block(s) = %ld\n",name,status->st_blocks);
        // on rajoute la taille qui correspond aux nombres de blocks de 512o divisé par 2
        taille+=status->st_blocks/2;
    } 
    return 0;
}


// test la fonction ftw
int main(int argc, char *argv[]){
    taille=0;     // on initialise la taille

    if (argc <= 1)
        ftw(".", list, 16); // 16 repertoires ouverts max
    else
        ftw(argv[1], list, 16);

    printf("%d\n", taille);
    return 0;
}
