#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>

// lit une ligne dans un fd ouvert  (fgets)
char * readLine ( char *adr,size_t size,int fd) {
    int nb= 0;
    char *str = adr;

    // si la taille est inférieur ou égale à 1, on ne fait rien
    if (size > 1) {
        // on lit 1 car que l'on place dans str
        // si le car est bien lu, read renvoie 1
        // on met a jour nb et on vérifie qu'on ne déborde pas de la taille du buffer
        // on regarde si le car lu n'est pas un \n
        while ((read(fd,str,1)==1) && (++nb < size -2) && (*str !='\n'))
            // on avance dans la chaine de car
            str++;
        *++str='\0'; // ajoute le  \0 à la fin de la chaine
    }

    // si le nb est différent de 0, on renvoie la chaine, sinon on renvoie NULL
    return nb ? adr : NULL ;
}

int main(int argc, char * argv[]) {
    int file=0;     // descripteur de fichier par défaut l'entrée standard
    int cible=1;    // descripteur de fichier de sortie par défault standard
    int S_MAX=80;   // taille du buffer
    char * ecrit = (char *) malloc(S_MAX*sizeof(char *));    // ligne
    char * ecrit2 = (char *) malloc(S_MAX*sizeof(char *));   // ligne

    // on teste si la création de la ligne s'est bien passée
    if (!ecrit || !ecrit2) {
        fprintf(stderr,"Erreur création de la sortie de la ligne\n");
        exit(EXIT_FAILURE);
    }

    // si on a plus de 3 arguments, erreur
    if (argc > 3) {
        fprintf(stderr,"usage : uniq [entree [sortie]]\n");
        exit(EXIT_FAILURE);
    }

    // si on a 1 ou 2 arg exactement, on ouvre le fichier d'entree
    if ((argc == 2 || argc == 3) && (file = open(argv[1],O_RDONLY)) == -1 ){
        // message d'erreur probleme d'ouverture du fichier
        fprintf(stderr,"uniq : error open read only"); 
        exit(EXIT_FAILURE);
    }

    // si on a 3 arg exactement, on ouvre le fichier de sortie
    if (argc == 3 && (cible = open(argv[2],O_WRONLY|O_CREAT|O_TRUNC,0644)) < 0){
        // message d'erreur probleme d'ouverture du fichier
        fprintf(stderr,"uniq : error open read only"); 
        exit(EXIT_FAILURE);
    }

    // le fichier d'entree est ouvert, ou c'est l'entree standard
    // le fichier de sortie est ouvert ou c'est la sortie standard
    // on lit la première ligne du fichier et on vérifie qu'elle n'est pas vide
    // on la stocke dans ecrit
    if (readLine(ecrit,S_MAX,file) != NULL) {
        // on lit la ligne suivante et on vérife qu'elle n'est pas vide
        while (readLine(ecrit2,S_MAX,file) != NULL) {
            if (strcmp(ecrit,ecrit2)) { // si la ligne est différente 
                write(cible,ecrit,S_MAX); // on ecrit la ligne sur cible
                strcpy(ecrit,ecrit2); // on remplace ecrit par ecrit2
            }
        }
        write(cible,ecrit,S_MAX); // on n'oublie pas d'écrire la dernière ligne
    }        
}
