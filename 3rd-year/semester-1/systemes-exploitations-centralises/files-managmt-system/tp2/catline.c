#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>



// lit une ligne dans un fd ouvert  (fgets)
char * readLine ( char *adr,size_t size,int fd) {
    int nb= 0;
    char *str = adr;

    // si la taille est inférieur ou égale à 1, on ne fait rien
    if (size > 1) {
        // on lit 1 car que l'on place dans str
        // si le car est bien lu, read renvoie 1
        // on met a jour nb et on vérifie qu'on ne déborde pas de la taille du buffer
        // on regarde si le car lu n'est pas un \n
        while ((read(fd,str,1)==1) && (++nb < size -2) && (*str !='\n'))  
            // on avance dans la chaine de car
            str++; 
        *++str='\0'; // ajoute le  \0 à la fin de la chaine 
    }

    // si le nb est différent de 0, on renvoie la chaine, sinon on renvoie NULL
    return nb ? adr : NULL ;
}

int main(int argc, char * argv[]) {
    int file=0;     // descripteur de fichier par défaut l'entrée standard
    int S_MAX=80;   // taille du buffer
    int nl=0;       // compteur de ligne
    char * ecrit= (char *) malloc(S_MAX*sizeof(char *));    // ligne

    // on teste si la création de la ligne s'est bien passée
    if (!ecrit) {
        fprintf(stderr,"Erreur création de la sortie de la ligne\n");
        exit(EXIT_FAILURE);
    }

    // si on a plus de 2 arguments, erreur
    if (argc > 2) {
        fprintf(stderr,"usage : catline [file]\n");
        exit(EXIT_FAILURE);
    }

    // si on 2 arg exactement, on ouvre le fichier d'entree
    if ((argc == 2) && (file = open(argv[1],O_RDONLY)) == -1 ){
        // message d'erreur problme d'ouverture du fichier
        fprintf(stderr,"catline : error open read only"); 
        exit(EXIT_FAILURE);
    }

    // le fichier d'entree est ouvert, ou c'est l'entree standard
    while (readLine(ecrit,S_MAX,file) != NULL) {
        ++nl;
        printf("%d : %s",nl,ecrit);
    }
}
