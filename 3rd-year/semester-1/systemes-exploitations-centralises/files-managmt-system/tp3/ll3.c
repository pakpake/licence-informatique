/*
 * ll3.c : affiche toute les entrees  d'un repertoire de manière recursive
 * utilise les appels systeme opendir,readdir,closedir 
 */

#include <stdio.h>      //librairie standard (stderr)
#include <dirent.h>     // manipulation des repertoire
#include <stdlib.h>
#include <errno.h>
#include <sys/stat.h>
#include <sys/time.h>
#include <sys/types.h>
#include <pwd.h>
#include <grp.h>
#include <time.h>
#include <string.h>

// fonction d'affichage du contenu d'un repertoire passé en paramètre
// le second paramètre est une chaine pour eventuellement faire un décalage de l'affichage
void ls_recur(char * chemin,char * prefixe) {
    DIR * nom_directorie;
    struct stat file_info;

    struct dirent * fichier ; // structure d'une entree

    char buffer[100];
    char sppref[100];
    char lfilename[250]="";

    time_t timestamp = time(NULL);
    struct tm * pTime = localtime(& timestamp);

    struct passwd *pwd; 
    struct group  *grp; 

    int count=0;

    strcpy(sppref,prefixe);

    // ourverture du repertoire
    if ((nom_directorie = opendir(chemin)) == NULL ){
        perror("ll :");
        exit(errno);
    }

    // boucle pour calculer le nombre de block et l'affciher avant la liste des fichiers
    while ((fichier = readdir(nom_directorie)) != NULL) {
        // appel à stat
        strcpy(lfilename,chemin);
        strcat(lfilename,"/");
        strcat(lfilename,fichier->d_name);
        if (stat(lfilename,&file_info) == -1) {
            perror("stat");
            exit(errno);   
        }
        count+=file_info.st_blocks/2;
    }
    printf("\n%stotal %d\n",sppref,count);

    // redéfinition du pointeur au début de la liste des fichiers
    rewinddir(nom_directorie);
    //boucle qui parcourt tous les fichiers du répertoire courant
    while ((fichier = readdir(nom_directorie)) != NULL) {
        // on met a jour le nom du fichier avec son chemin relatif
        strcpy(lfilename,chemin);
        strcat(lfilename,"/");
        strcat(lfilename,fichier->d_name);
        // récupération des infos du fichier
        if (stat(lfilename,&file_info) == -1) {
            perror("stat");
            exit(errno);   
        }

        // récupération des infos de groupe et user
        pwd = getpwuid(file_info.st_uid);
        grp = getgrgid(file_info.st_gid);

        // pour afficher la date/heure
        timestamp = file_info.st_atime;
        pTime = localtime(&timestamp);
        strftime(buffer, sizeof(buffer), "%b %d %R",pTime);

        // affcihage des espaces pour l'indentation
        printf("%s",sppref);
        // affichage des droits
        switch (file_info.st_mode & S_IFMT) {
            case S_IFBLK:  printf("b"); break;
            case S_IFCHR:  printf("c"); break; 
            case S_IFDIR:  printf("d"); break; //It's a (sub)directory 
            case S_IFIFO:  printf("p"); break; //fifo
            case S_IFLNK:  printf("l"); break; //Sym link
            case S_IFSOCK: printf("s"); break;
                           //Filetype isn't identified
            default:       printf("-"); break;
        }
        //droits
        printf( (file_info.st_mode & S_IRUSR) ? "r" : "-");
        printf( (file_info.st_mode & S_IWUSR) ? "w" : "-");
        printf( (file_info.st_mode & S_IXUSR) ? "x" : "-");
        printf( (file_info.st_mode & S_IRGRP) ? "r" : "-");
        printf( (file_info.st_mode & S_IWGRP) ? "w" : "-");
        printf( (file_info.st_mode & S_IXGRP) ? "x" : "-");
        printf( (file_info.st_mode & S_IROTH) ? "r" : "-");
        printf( (file_info.st_mode & S_IWOTH) ? "w" : "-");
        printf( (file_info.st_mode & S_IXOTH) ? "x" : "-");

        // affichage des autres infos de la ligne
        printf(" %ld %s %s %6ld %12s %s\n",
                file_info.st_nlink,
                pwd->pw_name,
                grp->gr_name,
                file_info.st_size,
                buffer,
                lfilename);
        // si le fichier est un répertoire, on fait un appel récursif
        if (S_ISDIR(file_info.st_mode)) {
            if (lfilename[strlen(lfilename)-1]!='.') {
                // on augmente l'indentation de l'affichage
                strcat(sppref,"    ");
                // appel récursif avec le nouveau répertoire
                ls_recur(lfilename,sppref);
                // on diminue l'indentation de l'affichage
                sppref[strlen(sppref)-4]='\0';
                printf("\n");
            }
        }
    }
    // on ferme le répertoire
    closedir(nom_directorie);
}

int main ( int argc , char **argv ) {
    // test de bonne utilisation
    if ( argc != 2 ) { 
        printf("usage :  %s rep \n",argv[0]);
        exit(1);
    }

    ls_recur(argv[1],"");
    return 0;
}
