/*
 * ll.c : affiche toute les entrees (fichier ou repertoire)  d'un repertoire
 * utilise les appels systeme opendir,readdir,closedir 
 */

#include <stdio.h>      //librairie standard (stderr)
#include <dirent.h>     // manipulation des repertoire
#include <stdlib.h>
#include <errno.h>
#include <sys/stat.h>
#include <sys/time.h>
#include <time.h>

/* effectue un ll rep */
int main ( int argc , char **argv ) {
    struct stat file_info;

    DIR * nom_directorie ; // descriteur de repertoire
    struct dirent * fichier ; // structure d'une entree

    char buffer[100];

    time_t timestamp = time(NULL);
    struct tm * pTime = localtime(& timestamp);

    // teste de bonne utilisation
    if ( argc != 2 ) { 
        printf("usage :  %s rep \n",argv[0]);
        exit(1);
    }

    // ourverture du repertoire
    if ( (nom_directorie = opendir(argv[1]))== NULL ){
        perror("ll :");
        exit(errno);
    }

    // lectures des entress
    printf("inode  [droit]  uid      taille    date      nom\n");
    while ((fichier = readdir(nom_directorie)) != NULL) {
        // appel Ã  stat
        if (stat(fichier->d_name,&file_info) == -1) {
            perror("stat :");
            exit(errno);   
        }
        timestamp = file_info.st_atime;
        pTime = localtime(&timestamp);
        strftime(buffer, sizeof(buffer), "%b %d %R",pTime);
        
        printf("%5ld [%3o] %6d %10ld %12s %s\n",file_info.st_ino,
                file_info.st_mode & 0777,
                file_info.st_uid,
                file_info.st_size,
                buffer,
                fichier->d_name);
    }
    closedir(nom_directorie);
}
